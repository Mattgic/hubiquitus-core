<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.2/css/bootstrap.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.3.0/lodash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.1/angular.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.2/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/sockjs-client/0.3.4/sockjs.min.js"></script>
</head>
<body data-ng-app>
<script>
    function StatsCtrl($scope) {
        $scope.status = 'disconnected';
        $scope.stats = [];

        var sock = new SockJS('/stats');
        sock.onopen = function () {
            $scope.$apply(function () {
                $scope.status = 'connected'
            })
        };
        sock.onmessage = function (message) {
            var data = JSON.parse(message.data);
            var stats = _.sortBy(_.map(_.keys(data), function (key) {
                if (key === 'global') {
                    return {from: key, to: '', rate: data[key]};
                } else {
                    var pos = key.indexOf('->');
                    return pos > 0 ? {from: key.substr(0, pos), to: key.substr(pos + 2), rate: data[key]} : null;
                }
            }), function (stat) {
                return stat.to
            });
            $scope.$apply(function () {
                $scope.stats = stats;
            })
        };
        sock.onclose = function () {
            $scope.$apply(function () {
                $scope.status = 'disconnected'
            })
        };

    }
</script>
<div class="container" data-ng-controller="StatsCtrl">
    <h4><span class="label"
              data-ng-class="{'btn-warning': (status === 'disconnected'), 'btn-success': (status === 'connected')}">{{ status }}</span>
    </h4>

    <table class="table table-hover">
        <thead>
        <tr>
            <th>From</th>
            <th>To</th>
            <th style="width: 100px">Rate</th>
        </tr>
        </thead>
        <tbody data-ng-cloak>
        <tr data-ng-repeat="stat in stats">
            <td><h4>{{ stat.from }}</h4></td>
            <td><h4>{{ stat.to }}</h4></td>
            <td><h4><span class="label label-primary">{{ stat.rate }}</span></h4></td>
        </tr>
        </tbody>
    </table>
</div>
</body>
</html>